
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>IOS推送的实现-远程通知 - molon's dev</title>
	<meta name="author" content="molon">

	
	<meta name="description" content="Dec 27th, 2013 IOS推送的实现-远程通知 远程通知(即推送)的出现应该是由于苹果为了让APP后台时候一般不占用太多资源而创造的机制，像一般的IM系统，后台时候的聊天信息提醒就完全靠推送，实际上APP这时候应该是不做任何事情的。 推送的机制： APP去向系统注册通知 &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="molon's dev" type="application/atom+xml">
	
	<link rel="canonical" href="http://molon.me/deprecated/2013-12-27-iostui-song-de-shi-xian-yuan-cheng-tong-zhi.html">
	
	<link href="http://tp4.sinaimg.cn/1600725215/180/5628483622/1" rel="shortcut icon">
	
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="/javascripts/webjs/jquery1.7.2.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">	
	
	<img src="http://tp4.sinaimg.cn/1600725215/180/5628483622/1" alt="Profile Picture" style="width: 160px;" />
	
</div>
<h1><a href="/">molon's dev</a></h1>
<p class="subtitle">行之苟有恒，久久自芬芳</p>
<p class="subtitle">iOS探索者</p>
<nav id="main-nav"><ul class="main-navigation">
  <li style="margin-right:0px"><a href="/blog/archives">全部文章</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		<a class="github" href="https://github.com/molon" title="GitHub">GitHub</a>
		
<!--
		
		
		
		
		
		
		 -->
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
<script type="text/javascript" src="/javascripts/open-in-blank.js"></script>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-12-27T05:46:58+08:00" data-updated="true" itemprop="datePublished">Dec 27<span>th</span>, 2013</time></div>
	</div>
	<h1 class="title" itemprop="name">IOS推送的实现-远程通知</h1>
	<div class="entry-content" itemprop="articleBody"><p>远程通知(即推送)的出现应该是由于苹果为了让APP后台时候一般不占用太多资源而创造的机制，像一般的IM系统，后台时候的聊天信息提醒就完全靠推送，实际上APP这时候应该是不做任何事情的。 <br/>
推送的机制：</p>

<ul>
<li>APP去向系统注册通知</li>
<li>系统接受到了之后会为这个硬件上的APP向APNS(即苹果的推送服务器)请求一个唯一标识符，即为device token，用来标识当前苹果网络上，这个硬件上的这个APP的唯一身份。</li>
<li>APNS把这个token传回给APP。</li>
<li>APP把token传给其自己的服务端，服务端记录这个token在数据库，一般会对其进行和用户绑定。</li>
<li>若需要推送信息到APP，则服务端向APNS请求推送某信息到某一token的硬件上。</li>
<li>APNS推送信息到对应硬件。</li>
</ul>


<h1>引用</h1>

<p><a href="http://www.raywenderlich.com/32960/apple-push-notification-services-in-ios-6-tutorial-part-1">Apple Push Notification Services in iOS 6 Tutorial: Part &frac12;</a> <br/>
<a href="http://www.raywenderlich.com/32963/apple-push-notification-services-in-ios-6-tutorial-part-2">Apple Push Notification Services in iOS 6 Tutorial: Part 2/2</a></p>

<h1>配置流程</h1>

<h2>推送证书的配置和安装</h2>

<p>参见笔者的另外一篇文章，<a href="/2013/12/ioskai-fa-zhe-zheng-shu-de-pei-zhi-he-an-zhuang/">IOS开发者证书的配置和安装</a></p>

<h2>推送服务端的配置</h2>

<h3>创建pem文件</h3>

<ul>
<li>打开命令行，cd进入存放有cer和p12的文件夹。</li>
<li>输入以下命令</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl x509 -in aps_development.cer -inform der -out cer.pem 
</span><span class='line'>openssl pkcs12 -nocerts -out p12.pem -in MolonDevNotification.p12
</span><span class='line'>cat cer.pem p12.pem &gt; ck.pem
</span></code></pre></td></tr></table></div></figure>


<p>其中<code>aps_development.cer</code>和<code>MolonDevNotification.p12</code>根据实际名称来定。 <br/>
而第二个命令会让确认p12的导出密码，以及生成的pem对应使用密码。</p>

<ul>
<li>测试是否可用。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>openssl s_client -connect gateway.sandbox.push.apple.com:2195 -cert cer.pem -key p12.pem 
</span><span class='line'>#然后输入刚才设置的pem的密码即可</span></code></pre></td></tr></table></div></figure>


<p>若返回的是类似下图即表示可用 <br/>
<img src="/img/20131227/QQ20131227-40.png" alt="测试结果" /></p>

<h3>编写PHP请求推送代码</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">php</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Xcode控制台输出的Device Token</span>
</span><span class='line'><span class="c1">//这个玩意是直接要全都是十六进制的那种字符串，没有空格，没有&lt;&gt;符号</span>
</span><span class='line'><span class="nv">$deviceToken</span> <span class="o">=</span> <span class="s1">&#39;要接受消息的硬件的token&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 生成p12.pem时候设置的pem使用密码  </span>
</span><span class='line'><span class="nv">$passphrase</span> <span class="o">=</span> <span class="s1">&#39;pem密码&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 要推送的信息</span>
</span><span class='line'><span class="nv">$message</span> <span class="o">=</span> <span class="s1">&#39;你那么吊，你父母知道吗!&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">////////////////////////////////////////////////////////////////////////////////  </span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ctx</span> <span class="o">=</span> <span class="nb">stream_context_create</span><span class="p">();</span>
</span><span class='line'><span class="nb">stream_context_set_option</span><span class="p">(</span><span class="nv">$ctx</span><span class="p">,</span> <span class="s1">&#39;ssl&#39;</span><span class="p">,</span> <span class="s1">&#39;local_cert&#39;</span><span class="p">,</span> <span class="s1">&#39;ck.pem&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nb">stream_context_set_option</span><span class="p">(</span><span class="nv">$ctx</span><span class="p">,</span> <span class="s1">&#39;ssl&#39;</span><span class="p">,</span> <span class="s1">&#39;passphrase&#39;</span><span class="p">,</span> <span class="nv">$passphrase</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 和APNS建立一个连接，这里因为是开发者的，所以是sandbox下</span>
</span><span class='line'><span class="c1">// 正式版连接的服务器是ssl://gateway.push.apple.com:2195</span>
</span><span class='line'><span class="nv">$fp</span> <span class="o">=</span> <span class="nx">stream_socket_client</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;ssl://gateway.sandbox.push.apple.com:2195&#39;</span><span class="p">,</span> <span class="nv">$err</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">$errstr</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="nx">STREAM_CLIENT_CONNECT</span><span class="o">|</span><span class="nx">STREAM_CLIENT_PERSISTENT</span><span class="p">,</span> <span class="nv">$ctx</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$fp</span><span class="p">)</span>
</span><span class='line'>    <span class="k">exit</span><span class="p">(</span><span class="s2">&quot;Failed to connect: </span><span class="si">$err</span><span class="s2"> </span><span class="si">$errstr</span><span class="s2">&quot;</span> <span class="o">.</span> <span class="nx">PHP_EOL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">echo</span> <span class="s1">&#39;Connected to APNS&#39;</span> <span class="o">.</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create the payload body  </span>
</span><span class='line'><span class="nv">$body</span><span class="p">[</span><span class="s1">&#39;aps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>    <span class="s1">&#39;alert&#39;</span> <span class="o">=&gt;</span> <span class="nv">$message</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;sound&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;badge&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Encode the payload as JSON  </span>
</span><span class='line'><span class="nv">$payload</span> <span class="o">=</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$body</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Build the binary notification  </span>
</span><span class='line'><span class="nv">$msg</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">.</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> <span class="o">.</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;H*&#39;</span><span class="p">,</span> <span class="nv">$deviceToken</span><span class="p">)</span> <span class="o">.</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$payload</span><span class="p">))</span> <span class="o">.</span> <span class="nv">$payload</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Send it to the server  </span>
</span><span class='line'><span class="nv">$result</span> <span class="o">=</span> <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$fp</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$msg</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$result</span><span class="p">)</span>
</span><span class='line'>    <span class="k">echo</span> <span class="s1">&#39;Message not delivered&#39;</span> <span class="o">.</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>    <span class="k">echo</span> <span class="s1">&#39;Message successfully delivered&#39;</span> <span class="o">.</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Close the connection to the server  </span>
</span><span class='line'><span class="nb">fclose</span><span class="p">(</span><span class="nv">$fp</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<h2>编写App的代码</h2>

<h3>注册通知</h3>

<p>在<code>AppDelegate.m</code>里</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didFinishLaunchingWithOptions:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">launchOptions</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// 注册通知，把三种类型都注册了，用户允许的话，三个开关都会默认打开。</span>
</span><span class='line'>  <span class="p">[[</span><span class="n">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="nl">registerForRemoteNotificationTypes:</span>
</span><span class='line'>      <span class="p">(</span><span class="n">UIRemoteNotificationTypeBadge</span> <span class="o">|</span> <span class="n">UIRemoteNotificationTypeSound</span> <span class="o">|</span> <span class="n">UIRemoteNotificationTypeAlert</span><span class="p">)];</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>接收devide token</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didRegisterForRemoteNotificationsWithDeviceToken:</span><span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">deviceToken</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">token</span> <span class="o">=</span> <span class="n">deviceToken</span><span class="p">.</span><span class="n">description</span><span class="p">;</span>
</span><span class='line'>    <span class="n">token</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span> <span class="nl">stringByReplacingOccurrencesOfString:</span><span class="s">@&quot; &quot;</span> <span class="nl">withString:</span><span class="s">@&quot;&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="n">token</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span> <span class="nl">substringWithRange:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">token</span><span class="p">.</span><span class="n">length</span><span class="o">-</span><span class="mi">2</span><span class="p">)];</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;token:%@&quot;</span><span class="p">,</span><span class="n">token</span><span class="p">);</span> <span class="c1">//这里的token就可以直接放到PHP的push文件里了。</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didFailToRegisterForRemoteNotificationsWithError:</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;get token failed.&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>接收推送消息</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didReceiveRemoteNotification:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">userInfo</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%@&quot;</span><span class="p">,</span><span class="n">userInfo</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>推送消息的结构</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">aps</span> <span class="o">=</span>     <span class="p">{</span>
</span><span class='line'>        <span class="n">alert</span> <span class="o">=</span> <span class="s">&quot;你那么吊，你父母知道吗!&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="n">badge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="n">sound</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里是didReceiveRemoteNotification接收到的userInfo的结构，aps是系统用到的，必须要有，里面三个key分别对应<code>UIRemoteNotificationType</code>的<code>Alert</code>、<code>Badge</code>、<code>Sound</code>三种类型。而info是自定义添加的，想传啥传啥，但是也不是完全没限制，看下文php代码(结合上文完整php代码)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="c1">// Encode the payload as JSON  </span>
</span><span class='line'><span class="nv">$payload</span> <span class="o">=</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$body</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Build the binary notification  </span>
</span><span class='line'><span class="nv">$msg</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">.</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> <span class="o">.</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;H*&#39;</span><span class="p">,</span> <span class="nv">$deviceToken</span><span class="p">)</span> <span class="o">.</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$payload</span><span class="p">))</span> <span class="o">.</span> <span class="nv">$payload</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意里面的<code>$payload</code>，他的长度不能大于256，如果大于，推送将不成功。</p>

<h2>自定义推送的声音</h2>

<p>在工程里添加声音文件，例如a.caf，b.mp3。然后推送消息体里&#8221;sound&#8221; ＝> &ldquo;a.caf&#8221;，即可。</p>

<h1>深入测试</h1>

<ul>
<li> 硬件里<code>设置-&gt;通知中心-&gt;应用名称</code>中<code>提醒样式、应用程序图标标记、声音</code>三个选项分别对应<code>UIRemoteNotificationType</code>的<code>Alert</code>、<code>Badge</code>、<code>Sound</code>三种类型，修改他们则对应的<code>enabledRemoteNotificationTypes</code>都会引起变化。若三者都被关闭，则变成<code>None</code>。</li>
<li> APP在安装到手机上，第一次调用<code>registerForRemoteNotificationTypes</code>方法的时候会询问用户是否允许接受其通知。如果用户允许，<code>enabledRemoteNotificationTypes</code>则为刚才注册的几个通知类型<em>相与</em>，否则会是<code>None</code>。拒绝通知其实并不表示APNs不会Push过来，只是不显示没动静罢了。</li>
<li> 当<code>None</code>时不管联网与否，<code>didRegisterForRemoteNotificationsWithDeviceToken</code>方法不会执行，而非<code>None</code>时，联网状态下会执行，但未联网状态下若以前曾执行过一次，也会执行并获取上一次返回的token。</li>
<li> 若第一次就注册通知时候就没联网，<code>didRegister...DeviceToken</code>和 <code>didFail...WithError</code>方法都不会执行。</li>
<li> 用户拒绝了通知，只能在适当的时候检测并且提示其手动去改正，无法再像第一次那样请求是否允许。</li>
<li> 用户未联网时候，服务端也可以成功发送请求到APNs，等待用户联网之后，APNs会即刻把消息Push进来，所以每个消息最好有代表发送时间的参数，以方便应用确认时间。</li>
<li> 推送可自定义的声音可以是mp3格式，时间可以挺长，并且多个推送过来的话，偶尔会重叠播放，只是偶尔。。</li>
<li> 应用删除之后不会接受到对应推送消息，但再次安装之后，还是会把没接的接过来，和没联网一个样。</li>
<li> 应用开启状态下，即使状态栏在拉下状态遮挡应用界面时候，也不会外部提醒，并且通知列表不会添加任何项。</li>
<li> 应用最小化和锁屏状态下，有消息进来会外部提醒，并且保存在状态栏下拉通知列表内。即使点击一项进入应用，此项也不会删除。</li>
<li> 服务端发送消息中如果一直不包含badge或者其为0，应用就再也无法控制顶部通知列表项的删除，当然如果不想着删除，就要保证程序内的同一条Push消息的重用后逻辑。</li>
<li> Push消息中包含大于0的badge，然后在<code>didReceiveRemoteNotification</code>方法里  <code>setApplicationIconBadgeNumber:0</code>即可让顶部通知列表中关于本应用的所有消息删除，很遗憾要删只能删除全部的。针对于必须设置为0才能删除其的问题，而这个方式很容易影响到应用内其他地方关于badge的逻辑，一般是在<code>setApplicationIconBadgeNumber:0</code>之后再重新判断逻辑set回来。</li>
</ul>

</div>

</article>

	



<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
			</div>
			<footer id="footer" class="inner"><p>
<span class="credit"> 向<a href="http://onevcat.com/">OneV</a>对Blog模板的二次开发，以及小弟受到其很Blog的很多帮助，表示感谢！</span>
</p>

<p>
  2014 - 
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> , Design by <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></span>
</p></footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'molon';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://molon.me/deprecated/2013-12-27-iostui-song-de-shi-xian-yuan-cheng-tong-zhi.html';
        var disqus_url = 'http://molon.me/deprecated/2013-12-27-iostui-song-de-shi-xian-yuan-cheng-tong-zhi.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-46712562-2']);
  _gaq.push(['_setDomainName', window.location.host]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<!--	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46712562-2', window.location.host);
  ga('send', 'pageview');

</script> -->




		</div>
	</div>
</body>
</html>
